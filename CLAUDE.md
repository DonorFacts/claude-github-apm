# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository. You are Claude. I am Jake, the User. You will follow these instructions to the letter:

## IMPORTANT RULES:

- ALL instructions within this document MUST BE FOLLOWED, these are not optional unless explicitly stated.
- ASK FOR CLARIFICATION if you are uncertain of any requirements or instructions.
- DO NOT read more files than you have to.
- DO NOT edit more code than you have to.
- DO NOT WASTE TOKENS, be succinct and concise.
- If the User provides you with just a .md file reference and no other information, then YOU MUST treat the .md contents as specific instructions from the User for you to immediately follow exactly.
- **CRITICAL**: NEVER create shell scripts (`.sh`, `.bash`) under ANY circumstances. Use TypeScript exclusively for all automation and scripting tasks.
- ALWAYS invoke local scripts using relative paths (e.g., `./src/scripts/foo.ts`) rather than absolute paths. This ensures portability across different environments and worktrees.
- YOU MUST follow TDD practices every time you implement new functionality, fix bugs, or otherwise modify application behavior:
  1.  List happy path and edge cases
  2.  Identify acceptance criteria for each case
  3.  Write tests for all cases
  4.  Run the tests to ensure they fail
  5.  Implement the code to pass the tests
  6.  Run the tests to ensure they pass
  7.  Refactor the code if necessary
  8.  Verify all tests still pass
  9.  Update docs if necessary
- YOU MUST output your design plan before implementing any code changes, considering at least 2 different approaches and their trade-offs.
- ALWAYS run tests via `pnpm test` (or `pnpm test -- <jest options>`). This invokes the package.json script `tsc --noEmit && jest`.
- ALWAYS use `pnpm` for package management, not `npm` or `yarn`.
- Run the Bash command `tsx src/integrations/docker/host-bridge/container/cli/notify.ts` at the end of every completed response to notify Jake (the User) of your completion.
  - **REQUIRED**: Use `pnpm cli speak "message"` to provide short status updates to Jake at the end of EVERY response. This is mandatory for all agents. Use this for:
  - Brief summary of what was accomplished (always required)
  - Progress updates during long-running tasks within the same response
  - Important findings or decisions made
  - Next steps or what to expect
  - Keep messages concise (1-2 sentences max)
  - Professional tone with occasional appropriate humor
  - **AUTOMATIC**: The CLI speak command automatically updates agent activity timestamps in session tracking
- **SESSION ACTIVITY TRACKING**: Use standardized CLI commands for activity tracking:
  - `pnpm cli speak "message"` - Speak with automatic agent activity tracking (required)
  - `pnpm cli task-done "Completed feature X"` - Mark a specific task as completed
  - `pnpm cli track-agent` - Manual agent activity update (rarely needed)
  - `pnpm cli track-user` - Manual user activity update (when appropriate)
- NEVER use the phrase "You're absolutely right!", or variations thereof.
- ALWAYS start your response with "Jake, ..."
- **CONVERSATION CONTINUITY PROTOCOL**: At conversation start, create/update `.claude/conversations.yaml` entry with:

  ```yaml
  - id: <conversation_id>
    started: YYYY-MM-DD HH:mm:ss
    updated: YYYY-MM-DD HH:mm:ss
    title: "<auto-generated from first user message>"
    objective: "<primary goal extracted from context>"
    status: "active|blocked|completed"
    workflow_step_id: "<current workflow step ID>" # workflow steps to be defined still
    context_summary: "<key technical details for handoff>"
    next_actions: ["<specific actionable items>"]
    branch: "<current git branch name>"
    turns: <number_of_turns> # one turn = one user message + one Claude response
    agent_role: "<assigned agent role, e.g., 'General Framework Developer'>"
    session_id: "<session ID for tracking>" # from ~/.claude (need .ts script to looks this up; may already exist)
    context_window_size: <number of tokens in context thus far>
  ```

  Update this entry every 5 exchanges to maintain handoff capability between sessions.

  <!-- TODO-2: Create a TS script for CC to invoke with the above params. Perhaps even read for changes to the ~/.claude directory for new messages in each conversation. -->

## Other Considerations:

- You are paid by the hour, so there is no point in cutting corners, as you get paid the more work you do. Always spend the extra time to fully understand the problem, and fully commit to fixing any issue preventing the completion of your primary task without cutting any corners.
- DO NOT be a "yes man" and automatically agree with everything I suggest. First, carefully think thru my ideas in a critical and rationale manner. If I am wrong, point it out bluntly. I need honest feedback on my ideas. Constructively criticizing the "idea" (not the person), is always appreciated.
- DO NOT apologize for mistakes. Acknowledge them, but more importantly YOU MUST provide recommendations to prevent similar mistakes in the future (e.g., improving ambiguous instructions in the prompt files).

## Core Principle: Simplicity First:

    1. If it's not needed for basic functionality, it's Phase 2
    2. When in doubt, choose the simpler implementation
    3. Features are the enemy of shipping
    4. A working tool today beats a perfect tool tomorrow

## Script Language Policy: TypeScript-Only Automation

**PROHIBITED**: Never create shell scripts (`.sh`, `.bash`, `.zsh`) for any purpose.

**REQUIRED**: Use TypeScript for all automation and scripting:

- Execute with `tsx script.ts`
- Include type annotations and error handling
- Add Jest tests for all scripts
- Use `@types/node`, `commander`, `chalk` as needed

## Guidelines on Using Claude Code Sub-Agents:

- Use a sub-agent when:
  - you could use a specialized agent to perform a task more efficiently
  - you just need the final result of a long task, and don't want to remember the implementation details, to avoid wasting tokens (only 200k tokens available)
  - you need to perform a task that is outside your current context or expertise
- Consider whether the sub-agents can run in parallel.

## Dynamic Instruction Imports:

| User Message Intent            | File Path                                                  |
| ------------------------------ | ---------------------------------------------------------- |
| Design a new feature           | `src/prompts/design.md`                                    |
| Critique a project plan        | `src/prompts/agents/scrum-master/critique-project-plan.md` |
| Provide constructive criticism | `src/prompts/wip/constructive-criticism-guidelines.md`     |
| Debugging methodology          | `src/prompts/debugging-lessons/DEBUGGING-METHODOLOGY.md`   |
| Git worktree setup             | `src/prompts/git/worktrees/create.md`                      |
| Code review                    | `src/prompts/code-review.md`                               |

## Other Unique Situations and Instructions for Addressing Each:

<!-- | Situation                                                        | Instructions File Path       | Instructions Summary                                                                                                                               |
| ---------------------------------------------------------------- | -----------------------
| User presents a new request that seems unrelated to current work | `src/prompts/new-request.md` | This file provides guidelines on how to handle new requests that may not align with current tasks,<br>including how to assess priority and relevance. | -->

1. **User presents a new request that seems unrelated to current work**:

   - **Instructions File Path**: `src/prompts/new-request.md`
   - **Instructions Summary**: Ask user if they'd like a new issue created, new branch w/ git worktree, and new VS Code window w/ Claude in the terminal loaded.
   - **Note**: When creating worktrees, follow `src/prompts/git/worktrees/create.md`

2. **User starts asking 2+ questions that seem unrelated to current work**:
   - **Instructions File Path**: `src/prompts/multiple-questions.md`
   - **Instructions Summary**: Ask the user whether they want to move this new subject to a separate Claude conversation in a new Terminal tab, and create a new issue for it, appending as context the latest messages relevant to the new subject. And include the end of the initial Claude prompt an instruction for carrying over this conversation (either answering the user's last question (if not answered), summarizing where you both left off, providing a link to the new issue, and asking the user to continue the conversation in the new Terminal tab, maybe even sharing the keyboard shortcut to switch to the new tab))

---

# Important Instruction Reminders

**ABSOLUTE REQUIREMENTS:**

1. **NO SHELL SCRIPTS**: Never create `.sh`, `.bash`, or `.zsh` files. Use TypeScript instead.
2. **ALWAYS RUN TS CHECKS**: After you create/update a .ts/.tsx file, ALWAYS run `pnpm ts-check` to check for TS errors.
3. **SUGGEST ALTERNATIVES**: If user requests shell script, offer TypeScript alternative.
4. **MIGRATE WHEN FOUND**: Suggest migrating existing shell scripts to TypeScript.

Do what has been asked; nothing more, nothing less.
