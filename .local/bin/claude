#!/bin/bash
# APM Single Container Claude Wrapper
# This wrapper ensures the shared container exists then executes Claude inside it
# Place this at project root: ~/www/claude-github-apm/.local/bin/claude

set -e

# Find project root by looking for package.json and apm directory
find_project_root() {
  local current="$PWD"
  while [ "$current" != "/" ]; do
    if [ -f "$current/package.json" ] && [ -d "$current/apm" ]; then
      echo "$current"
      return 0
    fi
    # Check if we're in a worktree
    local parent=$(dirname "$current")
    if [ "$(basename "$parent")" = "worktrees" ]; then
      echo "$(dirname "$parent")"
      return 0
    fi
    current="$parent"
  done
  echo "Error: Not in an APM project directory" >&2
  return 1
}

# Detect project root
PROJECT_ROOT=$(find_project_root)
if [ -z "$PROJECT_ROOT" ]; then
  echo "❌ Could not find APM project root" >&2
  echo "Make sure you're in an APM project directory" >&2
  exit 1
fi

export APM_PROJECT_ROOT="$PROJECT_ROOT"

# Use tsx to run the container manager
# Note: This assumes pnpm/npm is available on host
cd "$PROJECT_ROOT"
exec pnpm tsx src/scripts/docker/apm-container.ts exec \
  /usr/local/bin/claude --dangerously-skip-permissions "$@"