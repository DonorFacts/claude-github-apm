#!/bin/bash
# APM CLI - Main entry point for agent management

set -e  # Exit on any error

APM_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
APM_EXTERNAL="../apm"
APM_SESSIONS="$APM_EXTERNAL/sessions"
APM_CONVERSATIONS="$APM_EXTERNAL/conversations"

# Ensure external directories exist
mkdir -p "$APM_SESSIONS" "$APM_CONVERSATIONS/active" "$APM_CONVERSATIONS/completed"

# Source helper functions
source "$(dirname "$0")/lib/common.sh"

show_help() {
    cat << EOF
APM - AI Package Manager for Collective Intelligence

Usage: apm <command> [options]

Commands:
  list                      Show all active conversations
  list --crashed           Show terminated conversations
  recover <id>             Restore specific conversation
  recover all              Restore all crashed conversations
  search <query>           Search across active conversations
  
  heartbeat <session-id>   Update session heartbeat (internal use)
  
Examples:
  apm list
  apm recover auth-dev-001-20250701
  apm recover all
  apm search "OAuth implementation"

Storage:
  Sessions:      $APM_SESSIONS/
  Conversations: $APM_CONVERSATIONS/
EOF
}

case "${1:-}" in
    list)
        exec "$(dirname "$0")/commands/list.sh" "${@:2}"
        ;;
    recover)
        exec "$(dirname "$0")/commands/recover.sh" "${@:2}"
        ;;
    search)
        exec "$(dirname "$0")/commands/search.sh" "${@:2}"
        ;;
    heartbeat)
        exec "$(dirname "$0")/commands/heartbeat.sh" "${@:2}"
        ;;
    -h|--help|help)
        show_help
        ;;
    "")
        show_help
        exit 1
        ;;
    *)
        echo "Error: Unknown command '$1'"
        echo "Run 'apm --help' for usage information"
        exit 1
        ;;
esac